const express = require('express');
const serialize = require('node-serialize');
const cors = require('cors');
const path = require('path');

const app = express();
const port = 3000;

// Global object to capture command output (accessible from unserialized code)
global.commandOutput = '';

app.use(express.json());
app.use(cors());
app.use(express.static('.'));

// Vulnerable endpoint - deserializes user input without validation
app.post('/unserialize', (req, res) => {
    try {
        const userInput = req.body.data;
        
        if (!userInput) {
            return res.status(400).json({ error: 'No data provided' });
        }

        // Reset command output before deserialization
        global.commandOutput = '';

        // Vulnerable: node-serialize unserialize allows code execution
        const result = serialize.unserialize(userInput);
        
        // Get the captured output
        const output = global.commandOutput || 'No output captured';
        
        res.json({
            success: true,
            result: result,
            commandOutput: output
        });
    } catch (error) {
        const output = global.commandOutput || 'No output captured';
        res.status(500).json({
            error: error.message,
            commandOutput: output
        });
    }
});

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

app.listen(port, () => {
    console.log(`ЁЯЪи Vulnerable server running on http://localhost:${port}`);
    console.log(`тЪая╕П  node-serialize version: ${require('node-serialize/package.json').version}`);
});
